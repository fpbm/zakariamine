<html>

<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>FPBM Notification</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.0/jquery.min.js" integrity="sha256-xNzN2a4ltkB44Mc/Jz3pT4iU1cmeR0FkXs4pru/JxaQ=" crossorigin="anonymous"></script>

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
<link rel="stylesheet" href="./theme1.css" >
<link rel="stylesheet" href="./main.css?v=">

<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<style>
	.loader1 {
    width: 100vw;
    height: 100vh;
    background: #fff;
    position: fixed;
    top: 0;
    left: 0;
}

.loader1-inner {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}


/* Spinner */
.lds-roller {
    display: inline-block;
    position: relative;
    width: 64px;
    height: 64px;
}
.lds-roller div {
    animation: lds-roller 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
    transform-origin: 32px 32px;
}
.lds-roller div:after {
    content: " ";
    display: block;
    position: absolute;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: #333;
    margin: -3px 0 0 -3px;
}
.lds-roller div:nth-child(1) {
    animation-delay: -0.036s;
}
.lds-roller div:nth-child(1):after {
    top: 50px;
    left: 50px;
}
.lds-roller div:nth-child(2) {
    animation-delay: -0.072s;
}
.lds-roller div:nth-child(2):after {
    top: 54px;
    left: 45px;
}
.lds-roller div:nth-child(3) {
    animation-delay: -0.108s;
}
.lds-roller div:nth-child(3):after {
    top: 57px;
    left: 39px;
}
.lds-roller div:nth-child(4) {
    animation-delay: -0.144s;
}
.lds-roller div:nth-child(4):after {
    top: 58px;
    left: 32px;
}
.lds-roller div:nth-child(5) {
    animation-delay: -0.18s;
}
.lds-roller div:nth-child(5):after {
    top: 57px;
    left: 25px;
}
.lds-roller div:nth-child(6) {
    animation-delay: -0.216s;
}
.lds-roller div:nth-child(6):after {
    top: 54px;
    left: 19px;
}
.lds-roller div:nth-child(7) {
    animation-delay: -0.252s;
}
.lds-roller div:nth-child(7):after {
    top: 50px;
    left: 14px;
}
.lds-roller div:nth-child(8) {
    animation-delay: -0.288s;
}
.lds-roller div:nth-child(8):after {
    top: 45px;
    left: 10px;
}
@keyframes lds-roller {
    0% {
        transform: rotate(0deg);
    }
    100% {
        transform: rotate(360deg);
    }
}



/*
*
* ==========================================
* FOR DEMO PURPOSES
* ==========================================
*
*/

body {
    min-height: 100vh;
	background-color: #edeff3;
    color: #202121
}

p.lead {
    text-shadow: 1px 1px 0 rgba(0, 0, 0, 0.1)
}

.btn-outline-light:hover, .btn-outline-light:focus {
    color: #de6262 !important;
  
}
</style>

</head>
<body >

<div class="loader1 text-center"   >
    <div class="loader1-inner">

        <!-- Animated Spinner -->
        <div id="loader"  class="lds-roller mb-3">
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
        </div>
		<h4 id="result" style="display:none;" class="text-uppercase font-weight-bold">أنتم مسجلون في التنبيهات</h4>
<div id="notiftype" style="display:none;" class="card">

<div  class="card-body">
<div class="row clearfix">
<div class=" col-md-12">
<div class="form-group">
<select  id='notification_type' align="centre" class="form-control">
<option value="NONE">-- نوع التنبيهات --</option>
  <option value="ALL">تـنـبـيـهـات آخـر الـمـسـتـجـدات</option>
  <option value="DPF">(Droit Privé Section française - LEF) الـتـنـبـيـهـات الـخـاصـة بــ</option>
  <option value="SEG">(Sciences Economiques et de Gestion - LEF) الـتـنـبـيـهـات الـخـاصـة بــ</option>
  <option value="SMP">(Sciences de la Matière Physique - LEF) الـتـنـبـيـهـات الـخـاصـة بــ</option>
  <option value="SMC">(Sciences de la Matière Chimie - LEF) الـتـنـبـيـهـات الـخـاصـة بــ</option>
  <option value="SVI">(Sciences de la vie - LEF) الـتـنـبـيـهـات الـخـاصـة بــ</option>
  <option value="SMA">(Sciences Mathématiques et Applications - LEF) الـتـنـبـيـهـات الـخـاصـة بــ</option>
  <option value="SMI">(Sciences Mathématiques et Informatiques - LEF) الـتـنـبـيـهـات الـخـاصـة بــ</option>
  <option value="MEAA">(Management des Entreprises agricoles et Agroalimentaires - LP) الـتـنـبـيـهـات الـخـاصـة بــ</option>
  <option value="MAC">(Marketing et Action Commerciale - LP)</option>
  <option value="MTLCI">(Management et Techniques logistiques du Commerce International - LP) الـتـنـبـيـهـات الـخـاصـة بــ</option>
  <option value="MB">(Métiers de la Banque - LP) الـتـنـبـيـهـات الـخـاصـة بــ</option>
  <option value="GRH">(Gestion des Ressources Humaines - LP) الـتـنـبـيـهـات الـخـاصـة بــ</option>
  <option value="ENR">(Energies Renouvelables - LP) الـتـنـبـيـهـات الـخـاصـة بــ</option>
  <option value="CCA">(Comptabilité Contrôle Audit - MASTER) الـتـنـبـيـهـات الـخـاصـة بــ</option>
  <option value="STRI">(Systèmes de Télécommunications et Réseaux Informatiques - MASTER) الـتـنـبـيـهـات الـخـاصـة بــ</option>
  <option value="PHYMO)">(Physique Moderne - MASTER) الـتـنـبـيـهـات الـخـاصـة بــ</option>
  <option value="IEREE">(Ingénierie des Energies Renouvelables et Efficacité Energétique - MASTER) الـتـنـبـيـهـات الـخـاصـة بــ</option>
  <option value="ISI">(Ingénierie des Systèmes Informatiques - MASTER) الـتـنـبـيـهـات الـخـاصـة بــ</option>
  <option value="MRH">(Management des Ressources Humaines - MASTER) الـتـنـبـيـهـات الـخـاصـة بــ</option>
</select>
</div>
</div>



</div>
		<button style="display:none;"  	id="requestpermission" type="button" onclick="requestpermission(2);" class="btn btn-primary btn-lg btn-block">اضغط هنا للاشتراك في التنبيهات</button>
</div>
</div>
        
        <!-- Spinner Description Text [For Demo Purpose]-->
        
    </div>
</div>
    <div id="token"></div>
    <div id="msg"></div>
    <div id="notis"></div>
    <div id="err"></div>
    <script src="https://www.gstatic.com/firebasejs/7.16.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.16.1/firebase-messaging.js"></script>

    <script>
	
  
	var getUrlParameter = function getUrlParameter(sParam) {
    var sPageURL = window.location.search.substring(1),
        sURLVariables = sPageURL.split('&'),
        sParameterName,
        i;

    for (i = 0; i < sURLVariables.length; i++) {
        sParameterName = sURLVariables[i].split('=');

        if (sParameterName[0] === sParam) {
            return sParameterName[1] === undefined ? true : decodeURIComponent(sParameterName[1]);
        }
    }
};

	function subscribeTokenToTopic(token, topic) {
  fetch('https://iid.googleapis.com/iid/v1/'+token+'/rel/topics/'+topic, {
    method: 'POST',
    headers: new Headers({
      'Authorization': 'key=AAAAM1rAZlk:APA91bGAA7rnOI6OCOqWzLhdaeic8dtJejqHrXy7oW1OC_Enu-U-SRv5nvO4VCdxI4P3CvVU0nfNcDffFIowm8Qc0HpQc_EfDPbBn4sfmQL3r_4Tl-nLvV2QAbtAgb_RhZZdgsG-mp9g'
    })
  }).then(response => {
    if (response.status < 200 || response.status >= 400) {
      throw 'Error subscribing to topic: '+response.status + ' - ' + response.text();
    }
    console.log('Subscribed to "'+topic+'"');
	document.getElementById('loader').style.display = 'none';
	document.getElementById('result').style.display = 'block';
	document.getElementById('requestpermission').style.display = 'none';
	// var notification = new Notification("نشكركم على اشتراككم في التنبيهات الخاصة بموقع الكلية المتعددة التخصصات ببني ملال.");

	window.close();

  }).catch(error => {
    console.error(error);
  })
}
	
        MsgElem = document.getElementById("msg");
        TokenElem = document.getElementById("token");
        NotisElem = document.getElementById("notis");
        ErrElem = document.getElementById("err");
        // Initialize Firebase
        // TODO: Replace with your project's customized code snippet
        var config = {
           apiKey: "AIzaSyAeft3qfbEFVujyy0myv-QowAV_Gu87u_E",
    authDomain: "fpbm-note.firebaseapp.com",
    databaseURL: "https://fpbm-note.firebaseio.com",
    projectId: "fpbm-note",
    storageBucket: "fpbm-note.appspot.com",
    messagingSenderId: "220565890649",
    appId: "1:220565890649:web:9f0f6fe5eb2ed83a2e3348",
    measurementId: "G-BXNN8ERMR4"
        };
        firebase.initializeApp(config);
        const messaging = firebase.messaging();

		
	if (!("Notification" in window)) {
				console.log("This browser does not support desktop notification");
			}
			else if (Notification.permission === "granted") {
				navigator.serviceWorker.register('../messaging-sw.js')
				.then((registration) => {
					messaging.useServiceWorker(registration);
					issub(token);
					
					});	

			}else{
			document.getElementById('loader').style.display = 'none';
			document.getElementById('result').style.display = 'none';
			document.getElementById('requestpermission').style.display = 'block';
			document.getElementById('notiftype').style.display = 'block';
			
			navigator.serviceWorker.register('../messaging-sw.js')
			.then((registration) => {
				messaging.useServiceWorker(registration);
				});
			}
		
function requestpermission(way) {
	var topic=document.getElementById('notification_type').value;
		if(topic=="NONE" && way==0){
		
		}else if(topic=="NONE" && way==1){
			document.getElementById('loader').style.display = 'none';
			document.getElementById('result').style.display = 'none';
			document.getElementById('requestpermission').style.display = 'block';
			document.getElementById('notiftype').style.display = 'block';
		}else{
        messaging.requestPermission()
            .then(function () {
				document.getElementById('loader').style.display = 'block';
				document.getElementById('result').style.display = 'none';
				document.getElementById('requestpermission').style.display = 'none';
				document.getElementById('notiftype').style.display = 'none';
                MsgElem.innerHTML = "Notification permission granted." 
                console.log("Notification permission granted.");
                // get the token in the form of promise
				console.log('Loading the token...');
                return messaging.getToken()
            })
            .then(function(token) {
					console.log('token found');
					console.log("token is : " + token);	
					storetokenandtopic(token,topic);
					subscribeTokenToTopic(token, topic);
            })
            .catch(function (err) {
                ErrElem.innerHTML =  ErrElem.innerHTML + "; " + err
                console.log("Unable to get permission to notify.", err);
            });
		}	
}
	
function deleteToken() {
    messaging.getToken()
    .then(function (currentToken) {
        messaging.deleteToken(currentToken)
        .then(function () {
            console.log('Token deleted.');
           
        })
        .catch(function (err) {
            console.log('Unable to delete token. ', err);
        });
    })
    .catch(function (err) {
        console.log('Error retrieving token. ', err);
        showToken('Error retrieving token. ', err);
    });
}	
	
	
	function issub(token) {		
		$.ajax({
                    url: 'https://spreadsheets.google.com/feeds/list/1bvxZVMS4N2SSEqsa9IxdWk6vFngO5sNBKOPzhzR6ftI/1/public/values?alt=json&sq=token="'+token+'"',
					data:{},
					type:"GET",
					success:(data)=>{
					if(data['feed']['entry']==null){
					requestpermission(1);
					}else{
					document.getElementById('loader').style.display = 'none';
					document.getElementById('result').style.display = 'block';
					document.getElementById('requestpermission').style.display = 'none';
					document.getElementById('notiftype').style.display = 'none';
					}
					},
					complete:(data)=>{
						
					}
					});	
					
	}
	
	function storetokenandtopic(token,topic) {		
				$.ajax({
                    url: "https://docs.google.com/forms/d/e/1FAIpQLSdrvmTQ4YpoKvKdH7DHu0v2z8Fqx8nbsAjYJTIkUTB1Mlv0Kw/formResponse?",
					data: {"entry.541031524": token, "entry.175143184": topic},
                    type: "POST",
                    dataType: "xml",
                    success: function(d)
					{
					},
					error: function(x, y, z)
						{
							
						}
                });
					
	}

    </script>

    </body>

</html>